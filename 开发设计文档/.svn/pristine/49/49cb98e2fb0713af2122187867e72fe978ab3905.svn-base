<!DOCTYPE html>
<html>
<head>
<title>运营实时数据查询、公众号渠道管理_舒煌辉</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
</head>
<body>
<h2>运营实时数据查询管理台</h2>
<ul>
<li>开发分支：business.fr.20180612.operationalData </li>
</ul>
<h3>1、日常业务-还款日常管理菜单，辅商户代扣还款业务有重复数据bug</h3>
<ul>
<li>1. 查询条件交易类型为“辅商户代扣还款业务” 时查询回来的数据有重复；
辅商户代扣还款业务查询子句添加GROUP BY过滤；
改动的sql</li>
<li>BsPayOrdersMapper --&gt; queryGachaCheckDailyCount</li>
<li>BsPayOrdersMapper --&gt; queryGachaCheckDailyInfo</li>
</ul>
<pre>
-- 辅商户代扣还款
SELECT
	CASE
	WHEN a.partner_code = 'YUN_DAI_SELF' THEN
	'云贷'
	WHEN a.partner_code = 'ZSD' THEN
	'赞时贷'
	WHEN a.partner_code = 'ZAN' THEN
	'赞分期'
	WHEN a.partner_code = '7_DAI_SELF' THEN
	'7贷'
	ELSE
	''
	END AS partner_code,
	CASE WHEN (b.repay_type = 'OFFLINE_REPAY') THEN 
	'PARTNER_OFFLINE_REPAY'
	WHEN (a.payment_channel_id = 1 OR a.payment_channel_id IS NULL
	) THEN
	'DEPREPAY_MAIN_WITHHOLD_REPAY'
	WHEN (a.payment_channel_id = 2 AND channel_trans_type = 'DK'
	) THEN
	'DEPREPAY_ASSIST_WITHHOLD_REPAY'
	ELSE
	''
	END AS trans_type,
	 a.order_no,
	 b.partner_order_no AS thd_order_no,
	 a.amount AS trans_amount,
	 IFNULL(a.return_msg, '') AS status_remark,
		CASE WHEN a. STATUS = 5 THEN
	'处理中'
	WHEN a. STATUS = 6 THEN
	'成功'
	WHEN a. STATUS = 7 THEN
	'失败'
	WHEN a. STATUS = 1 THEN
	'创建'
	WHEN a. STATUS = 3 THEN
	'预下单成功'
	WHEN a. STATUS = 4 THEN
	'预下单失败'
	ELSE
	'未知或无'
	END AS `status`,
		CASE
	WHEN a.payment_channel_id = 1 THEN
	'主通道'
	WHEN a.payment_channel_id IS NULL THEN
	'主通道'
	WHEN a.payment_channel_id = 2 THEN
	'辅通道'
	END AS payment_channel_id,
	a.create_time AS request_time,
	a.update_time AS finish_time,
	'repay' AS select_name
FROM
	ln_repay b
LEFT JOIN ln_pay_orders a ON a.order_no = b.pay_order_no
WHERE a.channel = 'BAOFOO'
AND a.trans_type = 'REPAY'
AND channel_trans_type = 'DK'
AND b.repay_type IS NULL
AND date(a.update_time) >= '2018-06-01'
AND date(a.update_time) <= '2018-06-01'
AND a.payment_channel_id = 2
AND a. STATUS = 6
<font color=#DC143C>GROUP BY a.id</font>

</pre>
<p><a href="https://tower.im/projects/3d05349e05b2474dbd3198d04ac77804/todos/affc8284dee64e8e9cd32821d5c40de1/">还款日常管理菜单，辅商户代扣还款业务有重复数据-原型</a></p>
<h3>2、日常业务-还款日常管理菜单，新增合计值</h3>
<ul>
<li>1. 新增合计金额的合计sql BsPayOrdersMapper queryGachaCheckDailySum，合计金额可以根据查询条件变化；sql中的查询条件同BsPayOrdersMapper queryGachaCheckDailyCount；</li>
<li>2.StatisticsController dailyCheckGachaIndex() 把合计金额传给页面；</li>
<li>3.statistics/gachaDaily/index.vm 页面查询框下面新增 <font color=#DC143C>合计金额</font></li>
</ul>
<pre></font>
SELECT
	<font color=#DC143C>SUM(IFNULL(trans_amount, 0))</font>
FROM
(
	SELECT
		a.id, <font color=#DC143C>IFNULL(a.amount, 0) as trans_amount</font>
	FROM
		bs_pay_orders a
	WHERE
		a.channel = 'BAOFOO'
	AND date(a.update_time) >= '2018-01-01'
	AND date(a.update_time) <= '2018-06-12'
	AND a. STATUS = 6
	AND 1 > 2

	UNION ALL
	SELECT
		a.id, <font color=#DC143C>IFNULL(a.amount, 0) as trans_amount</font>
	FROM
		bs_sys_receive_money a
	WHERE
	 date(a.update_time) >= '2018-01-01'
	AND date(a.update_time) <= '2018-06-12'
	AND a. STATUS = 'SUCC'
	AND 1 > 2

	UNION ALL
	SELECT
		b.id, <font color=#DC143C>IFNULL(b.total, 0) as trans_amount</font>
	FROM
		ln_compensate a,
		ln_compensate_detail b
	WHERE
		a.id = b.compensate_id
	AND (
		a.partner_code = 'YUN_DAI_SELF'
		OR a.partner_code = 'ZSD'
		OR a.partner_code = '7_DAI_SELF'
	)
	AND date(a.update_time) >= '2018-01-01'
	AND date(a.update_time) <= '2018-06-12'
	AND b. STATUS = 'SUCC'
	AND 1 > 2

	UNION ALL
	SELECT
		a.id, <font color=#DC143C>IFNULL(a.amount, 0) as trans_amount</font>
	FROM
		ln_pay_orders a
	WHERE
		1 > 2
	AND date(a.update_time) >= '2018-01-01'
	AND date(a.update_time) <= '2018-06-12'
	AND a. STATUS = 6

	UNION ALL
	SELECT
		a.id, <font color=#DC143C>IFNULL(a.amount, 0) as trans_amount</font>
	FROM
		ln_repay b
	LEFT JOIN ln_pay_orders a ON a.order_no = b.pay_order_no
	WHERE
		a.channel = 'BAOFOO'
	AND a.trans_type = 'REPAY'
	AND channel_trans_type = 'DK'
	AND b.repay_type IS NULL
	AND date(a.update_time) >= '2018-01-01'
	AND date(a.update_time) <= '2018-06-12'
	AND a.payment_channel_id = 2
	AND a. STATUS = 6
) t
</pre>
<p><a href="https://tower.im/projects/3d05349e05b2474dbd3198d04ac77804/todos/84c8c53ae42943e0b39a5f353907d948/">还款日常管理菜单，新增合计值-原型</a></p>
<h3>3、公众号渠道管理</h3>
<pre>
<font color=#DC143C><1>、公众号渠道管理新增渠道时，用产品、客服提供的数据，用sql脚本在bs_agent表中新增数据，公众号渠道管理页面不加另外的新增功能；
<2>、新增的渠道公众号用户购买数据结算是否要考虑？后续有相应的需求再统计； </font>

（1）用户微信信息表bs_wx_info新增渠道wx_agent_id，外键关联到bs_wx_agent表;
（2）公众号渠道管理新增数据，生成带参数的二维码，参数为渠道id，<font color=#DC143C>调用微信接口</font>；
（3）用户扫描后，关注后获取用的信息，信息写入微信信息表bs_wx_info,参数agent_id也同时写入；
（4）用户未关注
数据校验：
根据用户的openId查询，如果用户在bs_wx_info有数据，说明用户已经关注币港湾相关的公众号；
如果数据不存在则新增数据，关注后bs_wx_info新增数据is_follow = FOLLOW 关注，同时写入wx_agent_id;
（5）用户取消关注
bs_wx_info数据更新is_follow = UNFOLLOW 取消关注，根据openId查询bsWxInfoMapper.updateByPrimaryKeySelective(wxUser);
（6）查看粉丝明细，只显示净关注的数据is_follow = FOLLOW，取消关注的数据不显示；

-- 1、微信信息表bs_wx_info添加wx_agent_id字段
ALTER TABLE `bs_wx_info` ADD COLUMN `wx_agent_id` int(11) NULL DEFAULT null COMMENT '公众号渠道编号' AFTER `cancel_time`;

-- 2、bs_wx_info wx_agent_id添加外键
alter table bs_wx_info add constraint FK_Reference_239 foreign key (wx_agent_id) references bs_agent (id) on delete restrict on update restrict;

-- 3、新增公众号渠道管理菜单
INSERT INTO `m_menu` (`url`, `parent_id`, `order_num`, `name`, `note`) VALUES ('/wxAgent/getList.htm', '82', '14', '公众号渠道管理', '');

4. 永久二维码请求说明
生成带参数的二维码接口文档

http请求方式: POST
URL: https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=TOKEN
POST数据格式：json
POST数据例子：{"action_name": "QR_LIMIT_SCENE", "action_info": {"scene": {"scene_id": 123}}}

或者也可以使用以下POST数据创建字符串形式的二维码参数：
{"action_name": "QR_LIMIT_STR_SCENE", "action_info": {"scene": {"scene_str": "test"}}}

5. 通过ticket换取二维码
HTTP GET请求（请使用https协议）https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=TICKET
提醒：TICKET记得进行UrlEncode
String ticketEncoder = URLEncoder.encode(ticket, "UTF-8");

6. 扫描生成的二维码，点击关注，调用获取用户信息的接口，用户信息入微信信息表bs_wx_info，渠道的二维码存入wx_agent_id；
</pre>
<p><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1443433542">生成带参数的二维码-接口文档</a></p>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
